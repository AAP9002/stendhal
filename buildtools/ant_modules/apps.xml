<?xml version='1.0'?>

<project>

	<target name="nativehelper">
		<!--
			To setup up the development environment on Linux:
			curl https://sh.rustup.rs -sSf | sh
			apt-get install mingw-w64
			cargo install cargo-license
			rustup target add x86_64-pc-windows-gnu
		-->

		<exec executable="cargo" dir="app/nativehelper" failonerror="true">
			<arg value="rustc" />
			<arg value="--release" />
			<arg value="--" />
			<arg value="-C" />
			<arg value="link-arg=-Wl,-rpath,$ORIGIN" />
		</exec>
		<exec executable="cargo" dir="app/nativehelper" failonerror="true">
			<arg value="rustc" />
			<arg value="--release" />
			<arg value="--target" />
			<arg value="x86_64-pc-windows-gnu" />
		</exec>
		<exec executable="cargo" dir="app/nativehelper" failonerror="true" output="app/neutralinojs/extensions/binary/LICENSE.txt">
			<arg value="license" />
			<arg value="-ad" />
		</exec>
		<copy todir="app/neutralinojs/extensions/binary/" flatten="true">
			<fileset dir="app/nativehelper/target">
				<include name="release/nativehelper*" />
				<include name="release/build/*/out/*.dll" />
				<include name="release/build/*/out/*.so" />
				<include name="*/release/nativehelper.exe" />
				<include name="*/release/build/*/out/*.dll" />
				<include name="*/release/build/*/out/*.so" />
				<exclude name="**/*.d" />
			</fileset>
		</copy>
		<chmod dir="app/neutralinojs/extensions/binary/" type="file" perm="ugo+rx">
			<include name="nativehelper*" />
		</chmod>
	</target>


	<available file="app/neutralinojs/bin/neutralino-linux_x64" property="neutralinojs.present" />
	<target name="prepare-neutralinojs" unless="neutralinojs.present">
		<exec executable="neu" dir="app/neutralinojs" failonerror="true">
			<arg value="update" />
		</exec>
	</target>
	<target name="neutralinojs" depends="prepare-neutralinojs">
		<exec executable="neu" dir="app/neutralinojs" failonerror="true">
			<arg value="build" />
		</exec>
		<!-- Workaround for a data/gui/StendhalIcon.png being created -->
		<delete dir="app/data" failonerror="false" />
		<delete failonerror="false">
			<fileset dir="app/neutralinojs/dist/stendhal-client/">
				<include name="*arm*" />
				<include name="*mac*" />
				<include name="*.log" />
			</fileset>
		</delete>
		<chmod dir="app/neutralinojs/dist/stendhal-client/" type="file" perm="ugo+rx">
			<include name="stendhal*" />
			<include name="**/nativehelper*" />
		</chmod>
		<!--
		<copy todir="dist/stendhal-client" flatten="true">
			<fileset dir="app/neutralinoks">
				<include name="LICENSE.txt" />
			</fileset>
		</copy>
		-->
		<copy file="app/neutralinojs/LICENSE.txt" tofile="app/neutralinojs/dist/LICENSE.txt">
			<filterchain>
				<concatfilter append="app/neutralinojs/extensions/binary/LICENSE.txt" />
			</filterchain>
		</copy>

	</target>

</project>